import pytest
import socket
import paho.mqtt.client as mqtt

TIMEOUT = 5

@pytest.mark.vuln_id("MQTT_ANONYMOUS_ACCESS")
def test_MQTT_ANONYMOUS_ACCESS():
    ip = "{{ ip }}"
    port = 1883

    client = mqtt.Client()

    try:
        client.connect(ip, port, TIMEOUT)
        client.disconnect()
        assert True  # PASS → acesso anônimo permitido

    except (socket.timeout, ConnectionError, OSError):
        pytest.fail("MQTT não aceita conexão anônima")
