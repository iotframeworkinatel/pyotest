import pytest

try:
    import paho.mqtt.client as mqtt
except ImportError:
    pytest.skip("paho-mqtt not installed", allow_module_level=True)

def test_MQTT_ANON_ACCESS():
    ip = "{{ v.ip }}"
    port = int("{{ v.ports }}".split(",")[0])

    connected = {"ok": False}

    def on_connect(client, userdata, flags, rc):
        if rc == 0:
            connected["ok"] = True

    client = mqtt.Client()
    client.on_connect = on_connect
    client.connect(ip, port, 5)
    client.loop_start()
    client.loop_stop()

    assert connected["ok"] is True
