import pytest
import socket
import paramiko

TIMEOUT = 5

WEAK_CREDENTIALS = [
    ("root", "root"),
    ("admin", "admin"),
    ("test", "test"),
]

@pytest.mark.vuln_id("SSH_WEAK_CREDENTIALS")
def test_SSH_WEAK_CREDENTIALS():
    ip = "{{ ip }}"
    port = 22

    for user, password in WEAK_CREDENTIALS:
        try:
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(
                ip,
                port=port,
                username=user,
                password=password,
                timeout=TIMEOUT,
                allow_agent=False,
                look_for_keys=False,
            )
            ssh.close()
            assert True  # PASS → vulnerabilidade confirmada

        except paramiko.AuthenticationException:
            continue

        except (socket.timeout, paramiko.SSHException, OSError):
            pytest.skip("SSH indisponível")

    pytest.fail("SSH não aceita credenciais fracas")
