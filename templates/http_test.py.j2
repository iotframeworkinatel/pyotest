import pytest
import requests

@pytest.mark.vuln_id("HTTP_GENERIC")
def test_http_vulnerability():
    ip = "{{ v.ip }}"
    ports = "{{ v.ports }}".split(",")

    try:
        for p in ports:
            url = f"http://{ip}:{p}/"

            r = requests.get(url, timeout=5)

            # Heurística simples de exposição
            if r.status_code == 200 and (
                "Index of" in r.text or
                "../" in r.text or
                "admin" in r.text.lower()
            ):
                assert True  # vulnerabilidade confirmada

        pytest.fail("Nenhuma vulnerabilidade HTTP confirmada")

    except requests.exceptions.RequestException as e:
        pytest.skip(f"Erro HTTP: {e}")
