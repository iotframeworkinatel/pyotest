import pytest
import ftplib
import socket

TIMEOUT = 5

# Credenciais fracas + anônimo
WEAK_CREDENTIALS = [
    ("anonymous", ""),
    ("ftp", "ftp"),
    ("admin", "admin"),
    ("root", "root"),
    ("1234", "1234"),
]


@pytest.mark.vuln_id("FTP_WEAK_OR_ANON_LOGIN")
def test_FTP_WEAK_OR_ANON_LOGIN():
    """
    Testa se o servidor FTP aceita:
    - login anônimo
    - credenciais fracas conhecidas

    PASS  → vulnerabilidade confirmada
    SKIP  → serviço seguro ou indisponível
    """

    ip = "{{ v.ip }}"
    port = int("{{ v.ports }}".split(",")[0])

    for user, password in WEAK_CREDENTIALS:
        ftp = None
        try:
            ftp = ftplib.FTP()
            ftp.connect(ip, port, timeout=TIMEOUT)

            resp = ftp.login(user=user, passwd=password)

            # Código 230 = login bem-sucedido
            if resp and resp.startswith("230"):
                try:
                    ftp.quit()
                except Exception:
                    pass

                # Vulnerabilidade confirmada
                assert True

        except ftplib.error_perm:
            # Credencial rejeitada → comportamento esperado
            continue

        except (ftplib.all_errors, socket.error):
            # Servidor matou a conexão ou erro transitório
            continue

        finally:
            try:
                if ftp:
                    ftp.close()
            except Exception:
                pass

    # Nenhuma credencial funcionou → serviço seguro
    pytest.skip("FTP não aceita login anônimo nem credenciais fracas")
