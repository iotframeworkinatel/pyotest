import ftplib
import pytest
import socket

TIMEOUT = 5

WEAK_CREDENTIALS = [
    ("anonymous", "anonymous"),
    ("admin", "admin"),
    ("root", "root"),
    ("test", "test"),
]

@pytest.mark.vuln_id("FTP_WEAK_OR_ANON_LOGIN")
def test_FTP_WEAK_OR_ANON_LOGIN():
    ip = "{{ ip }}"
    port = int("{{ ports }}".split(",")[0])

    for user, password in WEAK_CREDENTIALS:
        ftp = None
        try:
            ftp = ftplib.FTP()
            ftp.connect(ip, port, timeout=TIMEOUT)
            resp = ftp.login(user=user, passwd=password)

            if resp and resp.startswith("230"):
                try:
                    ftp.quit()
                except Exception:
                    pass
                assert True  # PASS → vulnerabilidade confirmada

        except ftplib.error_perm:
            continue  # credencial rejeitada → tenta próxima

        except (socket.timeout, ConnectionError, OSError):
            pytest.skip("FTP indisponível")

        finally:
            try:
                if ftp:
                    ftp.close()
            except Exception:
                pass

    pytest.fail("FTP não aceita login anônimo nem credenciais fracas")
