import socket
import pytest


@pytest.mark.vulnerability
def test_{{ v.vulnerabilities | replace(" ", "_") | lower }}():
    """
    Hostname: {{ v.hostname }}
    IP: {{ v.ip }}
    Portas: {{ v.ports }}
    Vulnerabilidade: {{ v.vulnerabilities }}
    """

    # =========================
    # 1️⃣ CONTEXTO
    # =========================
    ip = "{{ v.ip }}"
    ports = [int(p) for p in "{{ v.ports }}".split(",")]
    vuln = "{{ v.vulnerabilities }}".lower()

    # =========================
    # 2️⃣ PROCESSAMENTO + 3️⃣ ASSERTIVA
    # =========================

    # --- FTP anônimo ---
    if "anonymous ftp" in vuln:
        import ftplib

        ftp = ftplib.FTP()
        ftp.connect(ip, ports[0], timeout=5)
        response = ftp.login()  # login anônimo
        ftp.quit()

        # ASSERTIVA
        assert "230" in response  # 230 = login bem sucedido

    # --- Directory listing HTTP ---
    elif "directory listing" in vuln:
        import requests

        r = requests.get(f"http://{ip}", timeout=5)

        # ASSERTIVA
        assert "Index of" in r.text

    # --- Directory traversal HTTP ---
    elif "directory traversal" in vuln:
        import requests

        r = requests.get(f"http://{ip}/../../../../etc/passwd", timeout=5)

        # ASSERTIVA
        assert "root:" in r.text

    # --- MQTT sem autenticação ---
    elif "mqtt" in vuln:
        import paho.mqtt.client as mqtt

        connected = False

        def on_connect(client, userdata, flags, rc):
            nonlocal connected
            connected = (rc == 0)

        client = mqtt.Client()
        client.on_connect = on_connect
        client.connect(ip, ports[0], 5)
        client.loop_start()
        client.loop_stop()
        client.disconnect()

        # ASSERTIVA
        assert connected is True

    # --- Telnet aberto ---
    elif "telnet" in vuln:
        import telnetlib

        tn = telnetlib.Telnet(ip, ports[0], timeout=5)
        banner = tn.read_some()
        tn.close()

        # ASSERTIVA
        assert banner is not None

    # --- SSH com credenciais fracas ---
    elif "ssh" in vuln:
        import paramiko

        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())

        success = False
        try:
            ssh.connect(
                ip,
                port=ports[0],
                username="root",
                password="root",
                timeout=5
            )
            success = True
        except Exception:
            success = False
        finally:
            ssh.close()

        # ASSERTIVA
        assert success is True

    # --- Banner grabbing ---
    elif "banner" in vuln:
        s = socket.socket()
        s.settimeout(5)
        s.connect((ip, ports[0]))
        banner = s.recv(1024)
        s.close()

        # ASSERTIVA
        assert len(banner) > 0

    else:
        pytest.skip("Vulnerabilidade sem teste automatizado definido")
