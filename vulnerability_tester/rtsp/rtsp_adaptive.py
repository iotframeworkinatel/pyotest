"""
Adaptive RTSP test variants -- ONLY executed by the AutoML/adaptive strategy.
These tests probe for default credentials, unauthorized access, and path
traversal vulnerabilities in RTSP services beyond the static OPTIONS check.
"""
import socket
import base64
import logging


def test_rtsp_default_credentials(ip, port=554, timeout=3):
    """
    Try common RTSP default credentials using DESCRIBE with Basic auth.
    Many IP cameras ship with well-known default usernames and passwords.
    Returns True if any credential pair grants access (200 OK).
    """
    credentials = [
        ("admin", "admin"),
        ("admin", "12345"),
        ("admin", ""),
        ("root", "root"),
        ("admin", "password"),
        ("user", "user"),
        ("admin", "888888"),
        ("admin", "admin123"),
    ]

    for username, password in credentials:
        try:
            sock = socket.create_connection((ip, port), timeout=timeout)
            creds = f"{username}:{password}"
            auth_b64 = base64.b64encode(creds.encode()).decode()

            request = (
                f"DESCRIBE rtsp://{ip}:{port}/ RTSP/1.0\r\n"
                f"CSeq: 1\r\n"
                f"Authorization: Basic {auth_b64}\r\n"
                f"Accept: application/sdp\r\n\r\n"
            )

            sock.send(request.encode())
            response = sock.recv(4096).decode(errors="ignore")
            sock.close()

            if "200 OK" in response:
                logging.debug(
                    f"[rtsp_default_creds] Access granted with {username}:{password} "
                    f"on {ip}:{port}"
                )
                return True

        except Exception:
            pass

    return False


def test_rtsp_unauthorized_describe(ip, port=554, timeout=3):
    """
    Check if DESCRIBE method succeeds without any authentication.
    An unauthenticated DESCRIBE response reveals stream information
    and indicates the RTSP service lacks proper access control.
    """
    try:
        sock = socket.create_connection((ip, port), timeout=timeout)

        request = (
            f"DESCRIBE rtsp://{ip}:{port}/ RTSP/1.0\r\n"
            f"CSeq: 1\r\n"
            f"Accept: application/sdp\r\n\r\n"
        )

        sock.send(request.encode())
        response = sock.recv(4096).decode(errors="ignore")
        sock.close()

        # 200 OK without auth = vulnerability
        # 401 = auth required (good)
        if "200 OK" in response:
            logging.debug(
                f"[rtsp_unauth_describe] Unauthenticated DESCRIBE succeeded on {ip}:{port}"
            )
            return True

        return False

    except Exception:
        return False


def test_rtsp_path_traversal(ip, port=554, timeout=3):
    """
    Attempt path traversal in RTSP URI to access resources outside
    the intended scope. Tests common traversal patterns.
    """
    traversal_paths = [
        "/../../../../etc/passwd",
        "/../../../etc/shadow",
        "/..%2f..%2f..%2fetc/passwd",
        "/admin/../../../etc/passwd",
    ]

    for path in traversal_paths:
        try:
            sock = socket.create_connection((ip, port), timeout=timeout)

            request = (
                f"DESCRIBE rtsp://{ip}:{port}{path} RTSP/1.0\r\n"
                f"CSeq: 1\r\n"
                f"Accept: application/sdp\r\n\r\n"
            )

            sock.send(request.encode())
            response = sock.recv(4096).decode(errors="ignore")
            sock.close()

            # Check if the server responds with content instead of 404/400
            if "200 OK" in response:
                logging.debug(
                    f"[rtsp_path_traversal] Traversal succeeded with '{path}' on {ip}:{port}"
                )
                return True

            # Some servers leak error information
            response_lower = response.lower()
            if "root:" in response_lower or "passwd" in response_lower:
                return True

        except Exception:
            pass

    return False
