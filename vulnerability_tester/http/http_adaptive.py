"""
Adaptive HTTP test variants â€” ONLY executed by the AutoML/adaptive strategy.
These tests check for vulnerabilities NOT covered by the static test suite.
"""
import requests
from requests.auth import HTTPBasicAuth


def test_http_sensitive_files_extended(ip, port, timeout=3):
    """Check backup/config files NOT in the static list ['.env', '.git/config', 'config.php']."""
    extended_files = [
        ".env.bak", "backup.sql", "robots.txt", ".htaccess",
        "web.config", "composer.json", "package.json",
    ]
    try:
        for f in extended_files:
            r = requests.get(f"http://{ip}:{port}/{f}", timeout=timeout)
            if r.status_code == 200 and len(r.text) > 0:
                return True
        return False
    except Exception:
        return False


def test_http_open_admin_extended(ip, port, timeout=3):
    """Check hidden admin/debug/API endpoints NOT in static paths ['/admin', '/login', '/dashboard']."""
    hidden_paths = [
        "api/debug", "api/v2", "api/search", "api/session",
        "server-status", "server-info",
        "api/config", "actuator", "healthcheck",
    ]
    try:
        for p in hidden_paths:
            r = requests.get(f"http://{ip}:{port}/{p}", timeout=timeout)
            if r.status_code == 200:
                return True
        return False
    except Exception:
        return False


def test_http_cors_misconfiguration(ip, port, timeout=3):
    """Check for overly permissive CORS headers (Access-Control-Allow-Origin: *)."""
    try:
        r = requests.get(
            f"http://{ip}:{port}/",
            headers={"Origin": "http://evil.com"},
            timeout=timeout,
        )
        acao = r.headers.get("Access-Control-Allow-Origin", "")
        acac = r.headers.get("Access-Control-Allow-Credentials", "")
        if acao == "*":
            return True
        if acao == "http://evil.com" and acac.lower() == "true":
            return True
        return False
    except Exception:
        return False


def test_http_insecure_cookies(ip, port, timeout=3):
    """Check for cookies missing HttpOnly or Secure flags."""
    try:
        # Try endpoints likely to set cookies
        for path in ["api/session", ""]:
            r = requests.get(f"http://{ip}:{port}/{path}", timeout=timeout)
            set_cookie = r.headers.get("Set-Cookie", "")
            if set_cookie:
                lower = set_cookie.lower()
                if "httponly" not in lower or "secure" not in lower:
                    return True
        return False
    except Exception:
        return False


def test_http_trace_method(ip, port, timeout=3):
    """Check if TRACE method is enabled (Cross-Site Tracing vulnerability)."""
    try:
        r = requests.request("TRACE", f"http://{ip}:{port}/", timeout=timeout)
        return r.status_code == 200
    except Exception:
        return False


def test_http_default_credentials_extended(ip, port, timeout=3):
    """Try additional credential pairs beyond static COMMON_CREDENTIALS [('root','root'), ('admin','admin')]."""
    extra_creds = [
        ("user", "1234"),
        ("admin", "password"),
        ("admin", ""),
        ("test", "test"),
        ("root", "password"),
    ]
    try:
        for user, passwd in extra_creds:
            # Try main endpoint
            r = requests.get(
                f"http://{ip}:{port}/",
                auth=HTTPBasicAuth(user, passwd),
                timeout=timeout,
            )
            if r.status_code == 200 and "Welcome" in r.text:
                return True
            # Try hidden /api/v2 endpoint
            r2 = requests.get(
                f"http://{ip}:{port}/api/v2",
                auth=HTTPBasicAuth(user, passwd),
                timeout=timeout,
            )
            if r2.status_code == 200:
                return True
        return False
    except Exception:
        return False


def test_http_directory_traversal_encoded(ip, port, timeout=3):
    """Try URL-encoded path traversal variants not in static test."""
    payloads = [
        "..%2f..%2f..%2f..%2fetc/passwd",
        "..%252f..%252f..%252fetc/passwd",
        "....//....//....//etc/passwd",
        "%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd",
    ]
    try:
        for payload in payloads:
            r = requests.get(
                f"http://{ip}:{port}/{payload}",
                timeout=timeout,
                allow_redirects=False,
            )
            if r.status_code == 200 and "root:x:" in r.text:
                return True
        return False
    except Exception:
        return False


def test_http_sqli_probe(ip, port, timeout=3):
    """Test for reflected SQL injection indicators on search endpoints."""
    try:
        r = requests.get(
            f"http://{ip}:{port}/api/search",
            params={"q": "' OR '1'='1"},
            timeout=timeout,
        )
        if r.status_code == 200:
            text = r.text
            # Check if input is reflected without sanitization
            if "' OR '1'='1" in text:
                return True
        return False
    except Exception:
        return False
