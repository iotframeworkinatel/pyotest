"""
Adaptive Modbus TCP test variants â€” ONLY executed by the AutoML/adaptive strategy.
These tests check register types and write access not covered by static tests.
Static tests only read holding registers (0-2) and device ID.
"""
from pymodbus.client.sync import ModbusTcpClient


def test_modbus_write_coil(ip, port):
    """Test if coils are writable without authentication."""
    try:
        client = ModbusTcpClient(ip, port=port)
        client.connect()
        result = client.write_coil(0, True)
        client.close()
        return not result.isError()
    except Exception:
        return False


def test_modbus_read_input_registers(ip, port):
    """Read input registers (static tests only check holding registers)."""
    try:
        client = ModbusTcpClient(ip, port=port)
        client.connect()
        result = client.read_input_registers(0, 5)
        client.close()
        if result is None or result.isError():
            return False
        # Check if any non-zero values (actual data exposed)
        return any(v != 0 for v in result.registers)
    except Exception:
        return False


def test_modbus_read_discrete_inputs(ip, port):
    """Read discrete inputs (not covered by any static test)."""
    try:
        client = ModbusTcpClient(ip, port=port)
        client.connect()
        result = client.read_discrete_inputs(0, 5)
        client.close()
        return result is not None and not result.isError()
    except Exception:
        return False


def test_modbus_read_coils(ip, port):
    """Read coil status (not covered by any static test)."""
    try:
        client = ModbusTcpClient(ip, port=port)
        client.connect()
        result = client.read_coils(0, 5)
        client.close()
        return result is not None and not result.isError()
    except Exception:
        return False


def test_modbus_write_register(ip, port):
    """Test if holding registers are writable (unauthorized write access)."""
    try:
        client = ModbusTcpClient(ip, port=port)
        client.connect()
        # Write to a high address to avoid corrupting test data
        result = client.write_register(50, 9999)
        client.close()
        return not result.isError()
    except Exception:
        return False
