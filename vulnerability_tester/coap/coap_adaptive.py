"""
Adaptive CoAP test variants â€” ONLY executed by the AutoML/adaptive strategy.
These tests probe for hidden resources and write access not checked by static tests.
"""
import asyncio
from aiocoap import Context, Message
from aiocoap.numbers.codes import Code


async def _coap_get(ip, port, path):
    """Helper: send a CoAP GET request and return payload or None."""
    context = await Context.create_client_context()
    request = Message(code=Code.GET, uri=f"coap://{ip}:{port}/{path}")
    try:
        response = await asyncio.wait_for(
            context.request(request).response,
            timeout=5,
        )
        return response.payload
    except Exception:
        return None


async def _coap_method(ip, port, path, method):
    """Helper: send a CoAP PUT/DELETE request and return True if successful."""
    context = await Context.create_client_context()
    request = Message(code=method, uri=f"coap://{ip}:{port}/{path}", payload=b"test")
    try:
        response = await asyncio.wait_for(
            context.request(request).response,
            timeout=5,
        )
        return response.code.is_successful()
    except Exception:
        return False


def test_coap_hidden_resource(ip, port):
    """Probe for hidden CoAP resources not tested by static suite ['.well-known/core', 'hello']."""
    hidden_paths = ["secret", "config", "firmware", "debug", "admin", "status"]
    for path in hidden_paths:
        try:
            payload = asyncio.run(_coap_get(ip, port, path))
            if payload is not None:
                return True
        except Exception:
            continue
    return False


def test_coap_put_allowed(ip, port):
    """Check if PUT method is allowed on CoAP resources (unauthorized write access)."""
    writable_paths = ["config", "hello", "secret"]
    for path in writable_paths:
        try:
            success = asyncio.run(_coap_method(ip, port, path, Code.PUT))
            if success:
                return True
        except Exception:
            continue
    return False


def test_coap_delete_allowed(ip, port):
    """Check if DELETE method is allowed on CoAP resources (unauthorized delete access)."""
    paths = ["config", "hello", "secret"]
    for path in paths:
        try:
            success = asyncio.run(_coap_method(ip, port, path, Code.DELETE))
            if success:
                return True
        except Exception:
            continue
    return False
