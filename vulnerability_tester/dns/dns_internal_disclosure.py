"""Test if DNS server reveals internal hostnames (information disclosure)."""
import socket


def test_dns_internal_disclosure(ip, port):
    """
    Query for 'iot.local' domain to check if the DNS server
    reveals internal IoT network hostnames.
    """
    try:
        # DNS query for 'admin.iot.local' type A
        query = (
            b'\xab\xce'  # Transaction ID
            b'\x01\x00'  # Flags: standard query
            b'\x00\x01'  # Questions: 1
            b'\x00\x00\x00\x00\x00\x00'
            # Query: admin.iot.local
            b'\x05admin\x03iot\x05local\x00'
            b'\x00\x01'  # Type A
            b'\x00\x01'  # Class IN
        )

        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(3)
        sock.sendto(query, (ip, port))
        data, _ = sock.recvfrom(512)
        sock.close()

        # Check if we got an answer (ANCOUNT > 0)
        if len(data) >= 12:
            ancount = int.from_bytes(data[6:8], 'big')
            return ancount > 0
        return False
    except Exception:
        return False
