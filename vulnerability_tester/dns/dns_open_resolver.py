"""Test if DNS server acts as an open resolver (responds to arbitrary queries)."""
import socket


def test_dns_open_resolver(ip, port):
    """
    Send a DNS query for a common domain. If the server responds,
    it's acting as an open resolver â€” a security misconfiguration.
    """
    try:
        # Build a minimal DNS query for 'example.com' (type A)
        # Transaction ID: 0xABCD
        query = (
            b'\xab\xcd'  # Transaction ID
            b'\x01\x00'  # Flags: standard query, recursion desired
            b'\x00\x01'  # Questions: 1
            b'\x00\x00'  # Answer RRs: 0
            b'\x00\x00'  # Authority RRs: 0
            b'\x00\x00'  # Additional RRs: 0
            # Query: example.com, type A, class IN
            b'\x07example\x03com\x00'
            b'\x00\x01'  # Type A
            b'\x00\x01'  # Class IN
        )

        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(3)
        sock.sendto(query, (ip, port))
        data, _ = sock.recvfrom(512)
        sock.close()

        # If we got a response, the server is an open resolver
        return len(data) > 12  # DNS header is 12 bytes minimum
    except Exception:
        return False
