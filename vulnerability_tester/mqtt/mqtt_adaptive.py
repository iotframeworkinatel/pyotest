"""
Adaptive MQTT test variants â€” ONLY executed by the AutoML/adaptive strategy.
These tests check for retained messages, wildcard subscriptions, and sensitive topics
not covered by static tests [open_access, anon_publish, acl_bypass, topic_enum].
"""
import time
from paho import mqtt


def test_mqtt_retained_messages(ip, port):
    """Check for retained messages containing sensitive data on known IoT topics."""
    found = [False]

    def on_message(client, userdata, msg):
        if msg.payload and len(msg.payload) > 0:
            found[0] = True

    try:
        client = mqtt.Client()
        client.on_message = on_message
        client.connect(ip, port, 60)

        # Subscribe to common IoT device topics where retained messages might exist
        sensitive_topics = [
            "device/config", "device/firmware", "admin/credentials",
            "device/#", "config/#", "admin/#",
        ]
        for topic in sensitive_topics:
            client.subscribe(topic)

        client.loop_start()
        time.sleep(2)  # Wait for retained messages to arrive
        client.loop_stop()
        client.disconnect()
        return found[0]
    except Exception:
        return False


def test_mqtt_wildcard_subscribe(ip, port):
    """Test if wildcard subscription to ALL topics (#) is allowed."""
    found = [False]

    def on_message(client, userdata, msg):
        found[0] = True

    try:
        client = mqtt.Client()
        client.on_message = on_message
        client.connect(ip, port, 60)
        client.subscribe("#")  # Subscribe to every topic on the broker

        client.loop_start()
        time.sleep(2)
        client.loop_stop()
        client.disconnect()
        return found[0]
    except Exception:
        return False


def test_mqtt_sensitive_topic_access(ip, port):
    """Try subscribing to sensitive system and admin topic patterns."""
    try:
        client = mqtt.Client()
        client.connect(ip, port, 60)

        sensitive_topics = [
            "$SYS/broker/version",
            "$SYS/broker/uptime",
            "device/+/credentials",
            "admin/+",
        ]
        for topic in sensitive_topics:
            result = client.subscribe(topic)
            if result[0] == 0:  # MQTT_ERR_SUCCESS
                client.disconnect()
                return True
        client.disconnect()
        return False
    except Exception:
        return False
